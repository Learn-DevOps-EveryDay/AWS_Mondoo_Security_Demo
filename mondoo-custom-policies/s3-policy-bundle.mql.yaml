policies:
  - uid: aws-s3-security
    name: AWS S3 Security Baseline
    version: "1.0.1" # Updated version due to MQL changes
    tags:
      mondoo.com/category: cloud
      mondoo.com/platform: aws/s3
      mondoo.com/service: s3
    scoring_system: highest impact
    authors:
      - name: Mondoo
        email: hello@mondoo.com

    groups:
      - title: S3 Bucket Security Checks
        checks:
          # CHECK 1: Ensure S3 Block Public Access is enforced at the Account-Level
          - uid: s3-01
            title: Account-level Public Access Block must be fully enabled
            mql: aws.s3control.accountPublicAccessBlock.all(
                   BlockPublicAcls == true &&
                   IgnorePublicAcls == true &&
                   BlockPublicPolicy == true &&
                   RestrictPublicBuckets == true
                 )
            impact: 100

          # CHECK 2: Ensure all S3 Buckets enforce Server-Side Encryption
          # Uses the corrected encryption path: bucket.encryption.rule...
          - uid: s3-02
            title: All S3 buckets must have default encryption enabled (SSE-S3 or SSE-KMS)
            mql: aws.s3.buckets.all( encryption.rule.applyServerSideEncryptionByDefault.isNotNil )
            impact: 80

          # CHECK 3: Ensure all S3 buckets have versioning enabled
          # The field 'versioning' is typically correct.
          - uid: s3-03
            title: All S3 buckets must have versioning enabled
            mql: aws.s3.buckets.all( versioning.status == 'Enabled' )
            impact: 60

          # Referenced query example (shared check for a single bucket type)
          - uid: s3-log-bucket-encryption

        queries:
          # QUERY 1: Gather an inventory of all S3 buckets and public access status
          # Removing 'region' as it was causing a compile error; querying available fields.
          - uid: s3-d-1
            title: List all S3 buckets and public access status
            mql: |
              aws.s3.buckets { 
                name 
                publicAccessBlock.blockPublicAcls 
                versioning.status 
              }

          # QUERY 2: Gather details on unencrypted buckets for quick reporting
          # Corrected encryption path for the where clause and output fields.
          - uid: s3-d-2
            title: Identify S3 buckets without default encryption
            mql: |
              aws.s3.buckets.where( 
                encryption.rule.applyServerSideEncryptionByDefault.isNil
              ) {
                name
                creationDate
              }

        filters:
          - mql: asset.family == 'aws'

# ----------------------------------------------------------------------
queries:
  # REUSABLE CHECK: Ensure S3 buckets used for logging are also encrypted
  # Corrected encryption path.
  - uid: s3-log-bucket-encryption
    title: Log buckets must have default encryption enabled
    filters: 
      - mql: aws.s3.buckets.where( name == /log/ )
    mql: aws.s3.buckets.where( name == /log/ ).all( encryption.rule.applyServerSideEncryptionByDefault.isNotNil )
    impact: 70